@using ProductDataAccess.Models.Response;
@using ProductDataAccess.DTOs;
@using ProductDataAccess.ViewModels;
@model VoucherCreateVM
@{
    ViewData["PageTitle"] = "Create Voucher";
    ViewData["Vouchers"] = "active";
    ViewData["SearchURL"] = "AdminVoucher";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<main class="main-content position-relative border-radius-lg">
    @Html.Partial("~/Views/Shared/_AdminNavbar.cshtml")
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                        <h6>Create New Voucher</h6>
                    </div>
                    <div class="card-body">
                        @using (Html.BeginForm("Create", "AdminVoucher", FormMethod.Post, new { @class = "form-horizontal" }))
                        {
                            @Html.AntiForgeryToken()
                            <div class="row">
                                <!-- Voucher Code Section -->
                                <div class="col-md-6 mb-3">
                                    <label for="VoucherCode" class="form-label">Voucher Code</label>
                                    <input type="text" class="form-control" id="Code" name="Code" required placeholder="Enter Voucher Code">
                                </div>

                                <!-- Voucher Type Section -->
                                <div class="col-md-6 mb-3">
                                    <label for="VoucherType" class="form-label">Voucher Type</label>
                                    <select class="form-control" id="VoucherType" name="VoucherType" required>
                                        <option value="Discount">Discount</option>
                                        <option value="FreeShipping">Free Shipping</option>
                                    </select>
                                </div>

                                <!-- Discount Type Section -->
                                <div class="col-md-6 mb-3">
                                    <label for="DiscountType" class="form-label">Discount Type</label>
                                    <select class="form-control" id="DiscountType" name="DiscountType" required>
                                        <option value="Amount">Amount</option>
                                        <option value="Percent">Percent</option>
                                    </select>
                                </div>

                                <!-- Discount Value Section -->
                                <div class="col-md-6 mb-3">
                                    <label for="DiscountValue" class="form-label">Discount Value</label>
                                    <input type="number" class="form-control" id="DiscountValue" name="DiscountValue" required placeholder="Enter Discount Value">
                                </div>

                                <!-- Expiry Date Section -->
                                <div class="col-md-6 mb-3">
                                    <label for="ExpiryDate" class="form-label">Expiry Date</label>
                                    <input type="date" class="form-control" id="ExpiryDate" name="ExpiryDate" required>
                                </div>

                                <!-- Voucher Conditions Group (Min Order, Max Discount, Group, Product) -->
                                <div class="col-md-12 mb-3">
                                    <label for="VoucherConditions" class="form-label">Voucher Conditions</label>
                                    <div class="border p-3">
                                        <!-- Minimum Order Amount Section -->
                                        <div class="mb-3">
                                            <label for="MinOrderValue" class="form-label">Minimum Order Amount</label>
                                            <input type="number" class="form-control" id="MinOrderValue" name="MinOrderValue" placeholder="Enter minimum order amount">
                                        </div>

                                        <!-- Maximum Discount Amount Section -->
                                        <div class="mb-3">
                                            <label for="MaxDiscountAmount" class="form-label">Max Discount Amount</label>
                                            <input type="number" class="form-control" id="MaxDiscountAmount" name="MaxDiscountAmount" placeholder="Enter max discount amount">
                                        </div>

                                        <!-- Group Section -->
                                        <div class="mb-3">
                                            <label for="GroupName" class="form-label">Group</label>
                                            <select class="form-control" id="GroupName" name="GroupName">
                                                <option value="All">All</option>
                                                <option value="VIP">VIP</option>
                                                <option value="Member">Member</option>
                                            </select>
                                        </div>

                                        <!-- Product Selection Section -->
                                        <div class="mb-3">
                                            <label for="ProductId" class="form-label">Product</label>
                                            <input class="form-control" value="" id="ProductId" name="ProductId" hidden />
                                            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#productSelectionModal">
                                                Select Products
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Max Redeem Quantity Section -->
                                <div class="col-md-6 mb-3">
                                    <label for="MaxPerUsage" class="form-label">Max Redeem Quantity</label>
                                    <input type="number" class="form-control" id="MaxPerUsage" name="MaxPerUsage" required placeholder="Enter Max Redeem Quantity">
                                </div>

                                <!-- Max Quantity Section -->
                                <div class="col-md-6 mb-3">
                                    <label for="MaxUsage" class="form-label">Max Quantity</label>
                                    <input type="number" class="form-control" id="MaxUsage" name="MaxUsage" required placeholder="Enter Max Quantity">
                                </div>

                                <!-- Voucher Status Section -->
                                <div class="col-md-6 mb-3">
                                    <label for="Status" class="form-label">Voucher Status</label>
                                    <select class="form-control" id="Status" name="Status" required>
                                        <option value="active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                </div>

                                <!-- Submit Button Section -->
                                <div class="col-12 d-flex justify-content-end">
                                    <button type="submit" class="btn btn-primary">Create Voucher</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>




<!-- Modal -->
<div class="modal fade" id="productSelectionModal" tabindex="-1" aria-labelledby="productSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productSelectionModalLabel">Select Product for Voucher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Search bar -->
                <input type="text" class="form-control mb-3" id="productSearch" placeholder="Search for a product" aria-label="Search for a product">

                <!-- Product list with pagination -->
                <div class="table-responsive">
                    <table class="table align-items-center mb-0" id="productTable">
                        <thead>
                            <tr>
                                <th class="text-center">Product ID</th>
                                <th>Product</th>
                                <th class="text-center">Price($)</th>
                                <th class="text-center">Stock</th>
                                <th class="text-center">Select</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Product rows will be injected here dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination controls -->
                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center" id="paginationControls"></ul>
                </nav>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="confirmSelection">Confirm Selection</button>
            </div>
        </div>
    </div>
</div>


@section scripts {
    <script>
        $(document).ready(function () {
            let products = @Html.Raw(Json.Serialize(@Model.Products)); // Lấy danh sách sản phẩm từ Model
            let currentPage = 1;
            const itemsPerPage = 5;
            let selectedProducts = [];

            // Hàm hiển thị sản phẩm theo trang
            function renderProducts() {
                var search = $("#productSearch").val();
                if (search != null) {
                    search = search.toLowerCase();
                }
                let filteredProducts = products.filter(product =>
                    product.productName.toLowerCase().includes(search));

                let startIndex = (currentPage - 1) * itemsPerPage;
                let endIndex = Math.min(startIndex + itemsPerPage, filteredProducts.length);
                let paginatedProducts = filteredProducts.slice(startIndex, endIndex);
                
                let tbody = $("#productTable tbody");
                tbody.empty(); // Xóa dữ liệu cũ trước khi render lại

                // Render danh sách sản phẩm
                paginatedProducts.forEach(product => {
                    tbody.append(`
                                                    <tr data-product-id="${product.productId}">
                                            <td class="text-center">#${product.productId}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img src="/assets/images/products/${product.imgName}" class="avatar avatar-sm me-3" alt="product">
                                                    <span>${product.productName}</span>
                                                </div>
                                            </td>
                                            <td class="text-center">${product.price}</td>
                                            <td class="text-center">${product.stock}</td>
                                            <td class="text-center">
                                                                                             <input type="checkbox" class="select-product" ${selectedProducts.includes(product.productId) ? 'checked' : ''} data-product-id="${product.productId}" />
                                            </td>
                                        </tr>
                                    `);
                });

                // Render phân trang
                renderPagination(filteredProducts.length);
            }

            // Hàm render phân trang
            function renderPagination(totalItems) {
                let totalPages = Math.ceil(totalItems / itemsPerPage);
                let paginationControls = $("#paginationControls");
                paginationControls.empty();

                for (let i = 1; i <= totalPages; i++) {
                    paginationControls.append(`
                                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                                        </li>
                                    `);
                }
            }

            // Tìm kiếm sản phẩm
            $("#productSearch").on("change", function () {
                currentPage = 1; // Reset về trang đầu khi tìm kiếm
                renderProducts();
            });
            
            // Thay đổi trang
            $("#paginationControls").on("click", "a", function (e) {
                e.preventDefault();
                currentPage = $(this).data("page");
                renderProducts();
            });
           
            // Xử lý chọn sản phẩm khi nhấn vào checkbox
            $("#productTable").on("change", ".select-product", function () {
                let productId = $(this).data("product-id");

                // Nếu checkbox được chọn, thêm vào danh sách
                if ($(this).is(":checked")) {
                    if (!selectedProducts.includes(productId)) {
                        selectedProducts.push(productId);
                    }
                } else {
                    // Nếu bỏ chọn, xóa khỏi danh sách
                    selectedProducts = selectedProducts.filter(id => id !== productId);
                }

                console.log("Selected products: ", selectedProducts);
            });

            // Xử lý khi người dùng xác nhận chọn sản phẩm
            $("#confirmSelection").on("click", function () {
                // Xử lý các sản phẩm đã chọn, ví dụ: thêm vào danh sách voucher
                const selectedProductsJson = JSON.stringify(selectedProducts);

                // Gán chuỗi JSON vào input ẩn trong form
                $("#ProductId").val(selectedProductsJson);

                // Đóng modal sau khi xác nhận
                $("#productSelectionModal").modal('hide');
            });

            // Render sản phẩm lần đầu tiên
            renderProducts();
        });

    </script>
}
